<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>TOOLING SUPPORT - Login & Data Pelaksana</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; padding: 0; 
            background-color: #f4f4f4; 
            color: #333; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
        }
        header { 
            background-color: #003366; 
            color: white; 
            padding: 15px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .logo { font-size: 1.5em; font-weight: bold; }
        .main-content { flex: 1; padding: 40px 20px; text-align: center; }
        .subtitle { font-size: 1.1em; margin-bottom: 30px; color: #555; }
        
        /* Container Form */
        .form-container { 
            background: white; 
            padding: 35px; 
            border-radius: 15px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            max-width: 500px; 
            margin: 0 auto; 
        }
        .form-group { margin-bottom: 20px; text-align: left; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #003366; }
        input { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            box-sizing: border-box; 
            font-size: 1em; 
            transition: border-color 0.3s; 
            text-transform: uppercase; 
        }
        input[type="password"] { text-transform: none; } /* Password tidak kapital */
        input:focus { border-color: #003366; outline: none; }
        
        .btn, .submit { 
            background-color: #155724; 
            color: white; 
            width: 100%; 
            padding: 15px; 
            font-size: 1.1em; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: bold; 
            margin-top: 10px;
        }
        .btn:hover, .submit:hover { background-color: #0f4422; }
        .submit:disabled { background-color: #6c757d; }
        
        .error-msg { 
            color: #721c24; 
            background-color: #f8d7da; 
            border: 1px solid #f5c6cb; 
            padding: 10px; 
            border-radius: 5px; 
            margin-bottom: 20px; 
            display: none; 
        }
        #weekChecklist { width: 80px; text-align: center; }
    </style>
</head>
<body>

<header>
    <div class="logo">TOOLING SUPPORT - PELAKSANA</div>
</header>

<div class="main-content">
    <h1>Login & Data Pelaksana</h1>
    <p class="subtitle">Silakan masukkan akun dan data pelaksana untuk mengakses sistem monitoring.</p>

    <div class="form-container">
        <div id="error-alert" class="error-msg">Username atau Password salah!</div>

        <div class="form-group">
            <label for="username">Username Login</label>
            <input type="text" id="username" placeholder="Masukkan username" autocomplete="off">
        </div>
        <div class="form-group">
            <label for="password">Password Login</label>
            <input type="password" id="password" placeholder="Masukkan password">
        </div>
        
        <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">

        <h3>Data Pelaksana Checklist</h3>
        <div class="form-group">
            <label>Nama Pelaksana</label>
            <input type="text" id="namaPelaksana" placeholder="Masukkan nama lengkap">
        </div>
        <div class="form-group">
            <label>Nama Tools / Equipment</label>
            <input type="text" id="namaTools" placeholder="Contoh: COMPRESSOR">
        </div>
        <div class="form-group">
            <label>Capacity</label>
            <input type="text" id="capacity" placeholder="Contoh: 10 BAR">
        </div>
        <div class="form-group">
            <label>Minggu (Week)</label>
            <input type="number" id="weekChecklist" placeholder="W" min="1" max="53">
        </div>
        <div class="form-group">
            <label>Tanggal Checklist</label>
            <input type="date" id="tanggalChecklist">
        </div>

        <button class="submit" id="btnLanjut" onclick="validateAndProcess()">Lanjut ke Form Checklist</button>
    </div>
</div>

<script>
    // Konfigurasi Supabase
    const supabaseUrl = 'https://yutxomhfqodjzqqibewd.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1dHhvbWhmcW9kanpxcWliZXdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzNjMxODcsImV4cCI6MjA4MTkzOTE4N30.FWmgcuo517KhN0ujLNEZnYZlZ-vbo-jXz3HJjiEJ1tA';
    const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // Daftar User
    const users = [
        { username: "rizky", password: "123" },
        { username: "operator1", password: "456" },
        { username: "operator2", password: "789" },
        { username: "supervisor", password: "000" }
    ];

    // Inisialisasi Tanggal & Week
    const dateInput = document.getElementById('tanggalChecklist');
    const weekInput = document.getElementById('weekChecklist');
    
    dateInput.value = new Date().toISOString().split('T')[0];
    weekInput.value = getWeekNumber(dateInput.value);

    function getWeekNumber(date) {
        const d = new Date(date);
        d.setHours(0, 0, 0, 0);
        d.setDate(d.getDate() + 4 - (d.getDay() || 7));
        const startOfYear = new Date(d.getFullYear(), 0, 1);
        return Math.ceil((((d - startOfYear) / 86400000) + 1) / 7);
    }

    dateInput.addEventListener('change', function() { 
        weekInput.value = getWeekNumber(this.value); 
    });

    // Fungsi Gabungan: Login dan Simpan
    async function validateAndProcess() {
        const userField = document.getElementById('username').value;
        const passField = document.getElementById('password').value;
        const errorBox = document.getElementById('error-alert');

        // 1. Validasi Login
        const foundUser = users.find(u => u.username === userField && u.password === passField);

        if (!foundUser) {
            errorBox.style.display = 'block';
            setTimeout(() => { errorBox.style.display = 'none'; }, 3000);
            return;
        }

        // 2. Simpan User Aktif
        localStorage.setItem("activeUser", foundUser.username);

        // 3. Ambil Data Pelaksana
        const nama = document.getElementById('namaPelaksana').value.trim();
        const tools = document.getElementById('namaTools').value.trim();
        const capacity = document.getElementById('capacity').value.trim();
        const tanggal = dateInput.value;
        const week = weekInput.value;

        if (!nama || !tools || !capacity || !tanggal || !week) {
            return alert('Mohon lengkapi semua data pelaksana!');
        }

        const btn = document.getElementById('btnLanjut');
        btn.disabled = true; 
        btn.textContent = "Menyimpan...";

        try {
            // 4. Simpan ke Supabase
            const { data, error } = await _supabase.from('pelaksana').insert([{ 
                nama_pelaksana: nama.toUpperCase(), 
                nama_tools: tools.toUpperCase(), 
                capacity: capacity.toUpperCase(), 
                tanggal_checklist: tanggal,
                week: parseInt(week)
            }]).select('id').single();

            if (error) throw error;

            localStorage.setItem('pelaksana_id', data.id);
            window.location.href = 'checklist-form.html'; 

        } catch (error) {
            alert('Gagal: ' + error.message);
            btn.disabled = false; 
            btn.textContent = "Lanjut ke Form Checklist";
        }
    }

    // Mendukung Enter
    document.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            validateAndProcess();
        }
    });
</script>

</body>
</html>
