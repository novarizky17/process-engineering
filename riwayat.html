<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KARTU RIWAYAT - PT. AMARILYS KARISMA GEMILANG</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @page {
            size: A4 landscape;
            margin: 8mm;
        }

        body {
            font-family: Arial, Helvetica, sans-serif;
            margin: 0;
            padding: 0;
            background: #f1f5f9;
            color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 277mm;
            height: auto;
            background: white;
            padding: 8mm 12mm;
            box-sizing: border-box;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        /* INPUT TITIK-TITIK - NORMAL (TIDAK BOLD) */
        .input-dot {
            border: none;
            border-bottom: 1px dotted black;
            width: 380px; 
            font-family: Arial;
            font-size: 10.5pt;
            outline: none;
            background: transparent;
            font-weight: normal !important;
            color: #000;
        }

        /* INPUT TABEL - NORMAL (TIDAK BOLD) */
        .table-input {
            border: none;
            width: 95%;
            height: 100%;
            font-family: Arial;
            font-size: 9pt;
            text-align: center;
            outline: none;
            background: transparent;
            font-weight: normal !important;
        }

        /* AREA PENCARIAN */
        .search-area {
            background: #1e293b;
            padding: 15px;
            margin-bottom: 25px;
            display: flex;
            gap: 12px;
            align-items: center;
            border-radius: 6px;
            justify-content: center;
        }

        .search-area input, .search-area select {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #cbd5e1;
            font-weight: bold;
        }

        .btn-action {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 24px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
        }

        .header {
            position: relative;
            margin-bottom: 8px;
            height: 45px;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 12px;
            position: absolute;
            left: 0;
            top: 0;
        }

        .logo { width: 90px; height: auto; }
        .company-name { font-size: 13px; font-weight: bold; }

        .title {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            width: 100%;
            margin: 0;
            padding-top: 6px;
        }

        /* META SECTION - DITURUNKAN POSISINYA */
        .meta-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            margin-top: 60px; /* Diturunkan lebih rendah dari header */
        }

        .machine-info div { 
            margin-bottom: 8px; 
            font-size: 10.5pt; 
            font-weight: normal !important; 
        }
        
        .label { 
            font-weight: bold; 
            display: inline-block; 
            width: 160px; 
        }

        #d_mesin {
            font-weight: normal !important; 
        }

        .doc-info { text-align: left; font-size: 10.5pt; font-weight: normal !important; }
        .doc-info div { margin-bottom: 4px; }
        .doc-label { font-weight: bold; display: inline-block; width: 140px; }

        /* TABEL UTAMA - ISI TIDAK BOLD */
        .main-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
        }

        .main-table th {
            border: 1px solid black;
            padding: 6px;
            font-size: 9.5pt;
            text-align: center;
            background-color: #f8fafc;
            font-weight: bold;
        }

        .main-table td {
            border: 1px solid black;
            padding: 6px;
            font-size: 9.5pt;
            text-align: center;
            vertical-align: middle;
            height: 25px;
            font-weight: normal !important;
        }

        /* TANDA TANGAN */
        .signature-section { margin-top: 20px; }
        .signature-row {
            display: flex;
            justify-content: space-between;
            gap: 50px;
        }

        .sig-box { flex: 1; text-align: center; max-width: 300px; }
        .sig-title { font-weight: bold; font-size: 12.5pt; margin-bottom: 70px; text-transform: uppercase; }
        .sig-line { border-bottom: 1.5px solid black; width: 90%; margin: 0 auto 10px; }
        .sig-label { font-size: 11.5pt; font-weight: bold; }

        @media print {
            body { background: white; display: block; }
            .no-print, .search-area { display: none !important; }
            .container { width: 100%; box-shadow: none; padding: 0; }
            .input-dot { border-bottom: none; }
        }
    </style>
</head>
<body>

<div class="container">

    <div class="search-area no-print">
        <input type="text" id="mesin_search" placeholder="NAMA MESIN..." style="width: 200px;">
        <select id="bulan_search">
            <option value="">- Semua Bulan -</option>
            <option value="01">Januari</option><option value="02">Februari</option>
            <option value="03">Maret</option><option value="04">April</option>
            <option value="05">Mei</option><option value="06">Juni</option>
            <option value="07">Juli</option><option value="08">Agustus</option>
            <option value="09">September</option><option value="10">Oktober</option>
            <option value="11">November</option><option value="12">Desember</option>
        </select>
        <select id="tahun_search">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
            <option value="2027">2027</option>
            <option value="2028">2028</option>
            <option value="2029">2029</option>
            <option value="2030">2030</option>
        </select>
        <button onclick="fetchData()" class="btn-action">CARI DATA</button>
        <button onclick="window.print()" class="btn-action" style="background:#10b981">CETAK</button>
        <button onclick="window.location.href='laporan.html'" class="btn-action" style="background:#64748b">KEMBALI</button>
    </div>

    <div class="header">
        <div class="logo-area">
            <img src="https://amarilyskg.co.id/bootstrap/img/logo.png" alt="Logo AKG" class="logo">
            <div class="company-name">PT. AMARILYS KARISMA GEMILANG</div>
        </div>
        <div class="title">KARTU RIWAYAT</div>
    </div>

    <div class="meta-section">
        <div class="machine-info">
            <div><span class="label">NAMA MESIN</span>: <span id="d_mesin">-</span></div>
            <div><span class="label">NO. MESIN</span>: <input type="text" class="input-dot" placeholder="..."></div>
            <div><span class="label">TAHUN PEMBUATAN</span>: <input type="text" class="input-dot" placeholder="..."></div>
            <div><span class="label">LOKASI MESIN</span>: <input type="text" class="input-dot" placeholder="..."></div>
        </div>

        <div class="doc-info">
            <div><span class="doc-label">No Dokumen</span>: AF.SP 05.18.Rev-00</div>
            <div><span class="doc-label">Tanggal Terbit</span>: 02 Agustus 2024</div>
            <div><span class="doc-label">Halaman</span>: 1/1</div>
            <div><span class="doc-label">Tanggal Revisi</span>: -</div>
        </div>
    </div>

    <table class="main-table">
        <thead>
            <tr>
                <th style="width: 12%">Tanggal</th>
                <th style="width: 20%">Permasalahan</th>
                <th style="width: 20%">Tindakan</th>
                <th style="width: 20%">Spare Part</th>
                <th style="width: 16%">Keterangan</th>
                <th style="width: 12%">PIC</th>
            </tr>
        </thead>
        <tbody id="table_content">
            <script>
                for(let i=0; i<20; i++) {
                    document.write(`<tr>
                        <td>&nbsp;</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td><input type="text" class="table-input"></td>
                        <td></td>
                    </tr>`);
                }
            </script>
        </tbody>
    </table>

    <div class="signature-section">
        <div class="signature-row">
            <div class="sig-box">
                <div class="sig-title">DIBUAT</div>
                <div class="sig-line"></div>
                <div class="sig-label">PIC</div>
            </div>
            <div class="sig-box">
                <div class="sig-title">DIKETAHUI</div>
                <div class="sig-line"></div>
                <div class="sig-label">Spv</div>
            </div>
            <div class="sig-box">
                <div class="sig-title">DISETUJUI</div>
                <div class="sig-line"></div>
                <div class="sig-label">Superintendent</div>
            </div>
        </div>
    </div>
</div>

<script>
    const SB_URL = "https://yutxomhfqodjzqqibewd.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1dHhvbWhmcW9kanpxcWliZXdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzNjMxODcsImV4cCI6MjA4MTkzOTE4N30.FWmgcuo517KhN0ujLNEZnYZlZ-vbo-jXz3HJjiEJ1tA";
    const _sb = supabase.createClient(SB_URL, SB_KEY);

    async function fetchData() {
        const mesin = document.getElementById('mesin_search').value.trim().toUpperCase();
        const bulan = document.getElementById('bulan_search').value;
        const tahun = document.getElementById('tahun_search').value;

        if(!mesin) return alert("Masukkan Nama Mesin!");

        let query = _sb.from('laporan_maintenance').select(`
                created_at, nama_mesin, engineer_name, jam_mulai,
                maintenance_problems(description),
                maintenance_actions(description),
                maintenance_parts(nama_part, qty)
            `).eq('nama_mesin', mesin);

        if(bulan) {
            const startDate = `${tahun}-${bulan}-01T00:00:00`;
            const endDate = `${tahun}-${bulan}-31T23:59:59`;
            query = query.gte('jam_mulai', startDate).lte('jam_mulai', endDate);
        } else {
            query = query.gte('jam_mulai', `${tahun}-01-01`).lte('jam_mulai', `${tahun}-12-31`);
        }

        const { data: reports, error } = await query.order('jam_mulai', { ascending: true });

        if (error) return alert("Gagal mengambil data.");
        
        const tbody = document.getElementById('table_content');
        tbody.innerHTML = '';
        
        if (reports && reports.length > 0) {
            document.getElementById('d_mesin').innerText = reports[0].nama_mesin;
            
            reports.forEach(row => {
                const tr = document.createElement('tr');
                const tglRaw = row.jam_mulai ? row.jam_mulai.split('T')[0] : row.created_at.split('T')[0];
                const [y, m, d] = tglRaw.split('-');
                const date = `${d}/${m}/${y}`;

                const masalah = row.maintenance_problems.map(p => p.description).join(', ');
                const tindakan = row.maintenance_actions.map(a => a.description).join(', ');
                const parts = row.maintenance_parts.map(pt => `${pt.nama_part} (${pt.qty})`).join(', ');

                tr.innerHTML = `
                    <td>${date}</td>
                    <td style="text-align:left">${masalah}</td>
                    <td style="text-align:left">${tindakan}</td>
                    <td style="text-align:left">${parts}</td>
                    <td><input type="text" class="table-input"></td>
                    <td>${row.engineer_name}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        const remaining = 20 - (reports ? reports.length : 0);
        for (let i = 0; i < (remaining < 0 ? 0 : remaining); i++) {
            tbody.innerHTML += `<tr>
                <td>&nbsp;</td><td></td><td></td><td></td>
                <td><input type="text" class="table-input"></td>
                <td></td>
            </tr>`;
        }
    }
</script>
</body>
</html>
