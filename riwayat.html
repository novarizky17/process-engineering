<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KARTU RIWAYAT - PT. AMARILYS KARISMA GEMILANG</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @page { size: A4 landscape; margin: 8mm; }
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f9; color: #000; }
        .container { width: 277mm; margin: 20px auto; padding: 5mm 12mm; box-sizing: border-box; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 8px; }
        
        /* Area Pencarian */
        .search-area { background: #1e293b; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
        .search-input { flex-grow: 1; padding: 10px; border-radius: 5px; border: 1px solid #ccc; text-transform: uppercase; color: #000; }
        .btn-search { background: #3b82f6; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-search:hover { background: #2563eb; }

        .header { position: relative; margin-bottom: 5px; height: 40px; }
        .logo-area { display: flex; align-items: center; gap: 10px; position: absolute; left: 0; top: 0; }
        .logo { width: 85px; height: auto; }
        .company-name { font-size: 12px; font-weight: bold; }
        .title { font-size: 22px; font-weight: bold; text-align: center; width: 100%; margin: 0; padding-top: 5px; }
        
        .meta-section { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; margin-top: 20px; }
        .machine-info div { margin-bottom: 2px; font-size: 10pt; color: #000; }
        .label { font-weight: bold; display: inline-block; width: 135px; }
        .colon { padding: 0 5px; }
        
        /* Tabel Utama - Teks Hitam Normal (Tanpa Bold pada isi) */
        .main-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; color: #000; }
        .main-table th { border: 1px solid black; padding: 6px 5px; font-size: 8.5pt; text-align: center; background-color: #f0f0f0; font-weight: bold; }
        .main-table td { border: 1px solid black; padding: 6px 5px; font-size: 8.5pt; text-align: center; font-weight: normal; }
        
        .signature-section { margin-top: 15px; }
        .signature-row { display: flex; justify-content: space-between; gap: 40px; }
        .sig-box { flex: 1; text-align: center; }
        .sig-title { font-weight: bold; font-size: 10pt; margin-bottom: 50px; text-transform: uppercase; }
        .sig-line { border-bottom: 1.5px solid black; width: 80%; margin: 0 auto 5px; }
        .sig-label { font-size: 9pt; font-weight: bold; }

        .input-meta { border: none; border-bottom: 1px dotted black; width: 180px; outline: none; font-size: 10pt; color: #000; font-weight: normal; }

        @media print { 
            .no-print, .search-area { display: none !important; } 
            .container { margin: 0; box-shadow: none; width: 100%; }
            body { background: white; }
            .input-meta { border-bottom: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="search-area no-print">
        <input type="text" id="input_search_mesin" class="search-input" placeholder="KETIK NAMA MESIN..." onkeypress="if(event.key === 'Enter') searchMachine()">
        <button onclick="searchMachine()" class="btn-search">CARI DATA</button>
        <button onclick="window.print()" class="btn-search" style="background: #10b981;">CETAK</button>
        <button onclick="window.location.href='dashboard.html'" class="btn-search" style="background: #64748b;">KEMBALI</button>
    </div>

    <div class="header">
        <div class="logo-area">
            <img src="https://amarilyskg.co.id/bootstrap/img/logo.png" alt="Logo AKG" class="logo">
            <div class="company-name">PT. AMARILYS KARISMA GEMILANG</div>
        </div>
        <div class="title">KARTU RIWAYAT</div>
    </div>

    <div class="meta-section">
        <div class="machine-info">
            <div><span class="label">NAMA MESIN</span><span class="colon">:</span><span id="view_nama_mesin" style="font-weight:normal; color: #000;">-</span></div>
            <div><span class="label">NO. MESIN</span><span class="colon">:</span><input type="text" class="input-meta"></div>
            <div><span class="label">TAHUN PEMBUATAN</span><span class="colon">:</span><input type="text" class="input-meta"></div>
            <div><span class="label">LOKASI MESIN</span><span class="colon">:</span><input type="text" class="input-meta"></div>
        </div>
        <div class="doc-info" style="font-size: 9pt; text-align: right; color: #000;">
            <div><b>No Dokumen :</b> AF.SP 05.18.Rev-00</div>
            <div><b>Tanggal Terbit :</b> 02 Agustus 2024</div>
        </div>
    </div>

    <table class="main-table">
        <thead>
            <tr>
                <th style="width: 10%;">Tanggal</th>
                <th style="width: 22%;">Permasalahan</th>
                <th style="width: 22%;">Tindakan</th>
                <th style="width: 22%;">Spare Part</th>
                <th style="width: 14%;">Keterangan</th>
                <th style="width: 10%;">PIC</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="6" style="padding: 40px; color: #666; font-style: italic;">Masukkan nama mesin untuk melihat riwayat...</td></tr>
        </tbody>
    </table>

    <div class="signature-section">
        <div class="signature-row">
            <div class="sig-box"><div class="sig-title">DIBUAT</div><div class="sig-line"></div><div class="sig-label">PIC</div></div>
            <div class="sig-box"><div class="sig-title">DIKETAHUI</div><div class="sig-line"></div><div class="sig-label">Spv</div></div>
            <div class="sig-box"><div class="sig-title">DISETUJUI</div><div class="sig-line"></div><div class="sig-label">Superintendent</div></div>
        </div>
    </div>
</div>

<script>
    const SB_URL = "https://yutxomhfqodjzqqibewd.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1dHhvbWhmcW9kanpxcWliZXdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzNjMxODcsImV4cCI6MjA4MTkzOTE4N30.FWmgcuo517KhN0ujLNEZnYZlZ-vbo-jXz3HJjiEJ1tA";
    const _sb = supabase.createClient(SB_URL, SB_KEY);

    async function searchMachine() {
        const query = document.getElementById('input_search_mesin').value.trim().toUpperCase();
        if(!query) return alert("Mohon isi nama mesin!");

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px;">Memuat data...</td></tr>';

        const { data: reports, error } = await _sb
            .from('laporan_maintenance')
            .select(`
                id, created_at, nama_mesin, engineer_name, jam_mulai,
                maintenance_problems(description), 
                maintenance_actions(description),
                maintenance_parts(nama_part, qty)
            `)
            .eq('nama_mesin', query)
            .order('jam_mulai', { ascending: true });

        if (error) {
            alert("Terjadi kesalahan: " + error.message);
            return;
        }

        if (!reports || reports.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; color: #000;">Data tidak ditemukan.</td></tr>';
            document.getElementById('view_nama_mesin').innerText = "-";
            return;
        }

        document.getElementById('view_nama_mesin').innerText = reports[0].nama_mesin;
        tbody.innerHTML = '';

        reports.forEach(row => {
            const tr = document.createElement('tr');
            const dateStr = row.jam_mulai ? row.jam_mulai.split('T')[0] : row.created_at.split('T')[0];
            const [y, m, d] = dateStr.split('-');
            const formattedDate = `${d}/${m}/${y}`;
            
            const masalah = row.maintenance_problems.map(p => `• ${p.description}`).join('<br>');
            const tindakan = row.maintenance_actions.map(a => `• ${a.description}`).join('<br>');
            const parts = row.maintenance_parts.map(pt => `• ${pt.nama_part} (${pt.qty})`).join('<br>');

            tr.innerHTML = `
                <td>${formattedDate}</td>
                <td style="text-align:left; vertical-align: top;">${masalah || '-'}</td>
                <td style="text-align:left; vertical-align: top;">${tindakan || '-'}</td>
                <td style="text-align:left; vertical-align: top;">${parts || '-'}</td>
                <td>-</td>
                <td>${row.engineer_name || '-'}</td>
            `;
            tbody.appendChild(tr);
        });

        for(let i = reports.length; i < 15; i++) {
            const emptyTr = document.createElement('tr');
            emptyTr.innerHTML = '<td style="height: 22px;">&nbsp;</td><td></td><td></td><td></td><td></td><td></td>';
            tbody.appendChild(emptyTr);
        }
    }
</script>

</body>
</html>
