<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KARTU RIWAYAT - PT. AMARILYS KARISMA GEMILANG</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @page { size: A4 landscape; margin: 8mm; }
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: white; color: #000; }
        .container { width: 277mm; margin: 0 auto; padding: 5mm 12mm; box-sizing: border-box; }
        .header { position: relative; margin-bottom: 5px; height: 40px; }
        .logo-area { display: flex; align-items: center; gap: 10px; position: absolute; left: 0; top: 0; }
        .logo { width: 85px; height: auto; }
        .company-name { font-size: 12px; font-weight: bold; }
        .title { font-size: 22px; font-weight: bold; text-align: center; width: 100%; margin: 0; padding-top: 5px; }
        .meta-section { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; margin-top: 20px; }
        .machine-info div { margin-bottom: 2px; font-size: 10pt; }
        .label { font-weight: bold; display: inline-block; width: 135px; }
        .colon { padding: 0 5px; }
        .doc-info { text-align: left; font-size: 10pt; }
        .main-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .main-table th, .main-table td { border: 1px solid black; padding: 4px 5px; font-size: 9pt; text-align: center; height: 20px; }
        .main-table th { background-color: #f0f0f0; }
        .col-tgl { width: 12%; } .col-masalah { width: 20%; } .col-tindakan { width: 20%; }
        .col-spare { width: 20%; } .col-ket { width: 16%; } .col-pic { width: 12%; }
        .signature-section { margin-top: 15px; }
        .signature-row { display: flex; justify-content: space-between; gap: 40px; }
        .sig-box { flex: 1; text-align: center; }
        .sig-title { font-weight: bold; font-size: 12pt; margin-bottom: 65px; text-transform: uppercase; }
        .sig-line { border-bottom: 1.5px solid black; width: 85%; margin: 0 auto 8px; }
        .sig-label { font-size: 11pt; font-weight: bold; }
        
        /* Input styling untuk meta data */
        .input-meta { border: none; border-bottom: 1px dotted black; font-family: Arial; font-size: 10pt; width: 200px; outline: none; }
        @media print { .no-print { display: none; } .input-meta { border-bottom: none; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="logo-area">
            <img src="https://amarilyskg.co.id/bootstrap/img/logo.png" alt="Logo AKG" class="logo">
            <div class="company-name">PT. AMARILYS KARISMA GEMILANG</div>
        </div>
        <div class="title">KARTU RIWAYAT</div>
    </div>

    <div class="meta-section">
        <div class="machine-info">
            <div><span class="label">NAMA MESIN</span><span class="colon">:</span><span id="view_nama_mesin" style="font-weight:bold;">-</span></div>
            <div><span class="label">NO. MESIN</span><span class="colon">:</span><input type="text" class="input-meta" placeholder="..."></div>
            <div><span class="label">TAHUN PEMBUATAN</span><span class="colon">:</span><input type="text" class="input-meta" placeholder="..."></div>
            <div><span class="label">LOKASI MESIN</span><span class="colon">:</span><input type="text" class="input-meta" placeholder="..."></div>
        </div>
        <div class="doc-info">
            <div><span class="doc-label">No Dokumen</span><span class="colon">:</span> AF.SP 05.18.Rev-00</div>
            <div><span class="doc-label">Tanggal Terbit</span><span class="colon">:</span> 02 Agustus 2024</div>
            <button class="no-print" onclick="window.print()" style="margin-top: 10px; cursor: pointer;">Cetak Laporan</button>
        </div>
    </div>

    <table class="main-table">
        <thead>
            <tr>
                <th class="col-tgl">Tanggal</th>
                <th class="col-masalah">Permasalahan</th>
                <th class="col-tindakan">Tindakan</th>
                <th class="col-spare">Spare Part</th>
                <th class="col-ket">Keterangan</th>
                <th class="col-pic">PIC</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            </tbody>
    </table>

    <div class="signature-section">
        <div class="signature-row">
            <div class="sig-box"><div class="sig-title">DIBUAT</div><div class="sig-line"></div><div class="sig-label">PIC</div></div>
            <div class="sig-box"><div class="sig-title">DIKETAHUI</div><div class="sig-line"></div><div class="sig-label">Spv</div></div>
            <div class="sig-box"><div class="sig-title">DISETUJUI</div><div class="sig-line"></div><div class="sig-label">Superintendent</div></div>
        </div>
    </div>
</div>

<script>
    // Konfigurasi Supabase
    const SB_URL = "https://yutxomhfqodjzqqibewd.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1dHhvbWhmcW9kanpxcWliZXdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzNjMxODcsImV4cCI6MjA4MTkzOTE4N30.FWmgcuo517KhN0ujLNEZnYZlZ-vbo-jXz3HJjiEJ1tA";
    const _sb = supabase.createClient(SB_URL, SB_KEY);

    async function loadHistory() {
        // Ambil data laporan terbaru yang sudah approved
        const { data: reports, error } = await _sb
            .from('laporan_maintenance')
            .select(`
                id, created_at, nama_mesin, engineer_name, 
                maintenance_problems(description), 
                maintenance_actions(description),
                maintenance_parts(nama_part, qty)
            `)
            .order('created_at', { ascending: false });

        if (error) {
            console.error("Gagal mengambil data:", error);
            return;
        }

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        if (reports && reports.length > 0) {
            // Isi Nama Mesin di Meta Data dengan data terbaru
            document.getElementById('view_nama_mesin').innerText = reports[0].nama_mesin;

            reports.forEach(row => {
                const tr = document.createElement('tr');
                
                // Format Tanggal
                const date = new Date(row.created_at).toLocaleDateString('id-ID');
                
                // Gabungkan permasalahan & tindakan menjadi list
                const masalah = row.maintenance_problems.map(p => p.description).join(', ');
                const tindakan = row.maintenance_actions.map(a => a.description).join(', ');
                const parts = row.maintenance_parts.map(pt => `${pt.nama_part} (${pt.qty})`).join(', ');

                tr.innerHTML = `
                    <td>${date}</td>
                    <td style="text-align:left;">${masalah || '-'}</td>
                    <td style="text-align:left;">${tindakan || '-'}</td>
                    <td style="text-align:left;">${parts || '-'}</td>
                    <td>-</td>
                    <td>${row.engineer_name || '-'}</td>
                `;
                tbody.appendChild(tr);
            });

            // Tambahkan baris kosong sisa agar tabel tetap terlihat penuh (opsional)
            for(let i = reports.length; i < 15; i++) {
                const emptyTr = document.createElement('tr');
                emptyTr.innerHTML = '<td>&nbsp;</td><td></td><td></td><td></td><td></td><td></td>';
                tbody.appendChild(emptyTr);
            }
        }
    }

    window.onload = loadHistory;
</script>

</body>
</html>
