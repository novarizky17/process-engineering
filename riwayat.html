<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KARTU RIWAYAT - PT. AMARILYS KARISMA GEMILANG</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @page { size: A4 landscape; margin: 8mm; }
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f9; color: #000; }
        .container { width: 277mm; margin: 20px auto; padding: 5mm 12mm; box-sizing: border-box; background: white; border: 1px solid #000; }
        
        /* Area Navigasi & Pencarian (Hanya di layar) */
        .search-area { background: #1e293b; padding: 15px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; border-radius: 4px; }
        .search-input { flex-grow: 1; padding: 8px; text-transform: uppercase; border: 1px solid #ccc; font-weight: bold; }
        .btn-action { background: #3b82f6; color: white; border: none; padding: 8px 20px; cursor: pointer; font-weight: bold; }

        /* Header Dokumen Sesuai Gambar */
        .header { position: relative; margin-bottom: 10px; height: 50px; border-bottom: 2px solid #000; }
        .logo-area { display: flex; align-items: center; gap: 10px; position: absolute; left: 0; top: 0; }
        .logo { width: 85px; height: auto; }
        .company-name { font-size: 12px; font-weight: bold; }
        .title { font-size: 22px; font-weight: bold; text-align: center; width: 100%; margin: 0; }
        
        /* Meta Info Sesuai image_54aca2.png */
        .meta-section { display: flex; justify-content: space-between; margin-bottom: 15px; margin-top: 10px; }
        .machine-info div { margin-bottom: 3px; font-size: 10pt; }
        .label { font-weight: bold; display: inline-block; width: 140px; }
        .doc-info { font-size: 10pt; line-height: 1.4; text-align: left; }

        /* Tabel Utama */
        .main-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .main-table th, .main-table td { border: 1px solid black; padding: 5px; font-size: 9pt; text-align: center; }
        .main-table th { background-color: #f0f0f0; font-weight: bold; }
        
        /* Area Tanda Tangan Sesuai image_5c44e2.png */
        .sig-table { width: 100%; border-collapse: collapse; border: 1px solid black; margin-top: 20px; }
        .sig-table td { border: 1px solid black; text-align: center; width: 33.33%; vertical-align: middle; }
        .sig-header { font-weight: bold; padding: 5px; font-size: 10pt; height: 25px; border-bottom: 1px solid black; }
        .sig-space { height: 80px; display: flex; align-items: center; justify-content: center; padding: 5px; }
        .sig-space img { max-height: 70px; }
        .sig-footer { font-weight: bold; padding: 5px; font-size: 9pt; height: 25px; text-transform: uppercase; border-top: 1px solid black; }

        @media print { 
            .no-print { display: none !important; } 
            .container { margin: 0; border: none; width: 100%; }
            body { background: white; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="search-area no-print">
        <input type="text" id="input_search" class="search-input" placeholder="MASUKKAN NAMA MESIN...">
        <button onclick="searchData()" class="btn-action">CARI DATA</button>
        <button onclick="window.print()" class="btn-action" style="background:#10b981">CETAK</button>
        <button onclick="window.location.href='laporan.html'" class="btn-action" style="background:#64748b">KEMBALI</button>
    </div>

    <div class="header">
        <div class="logo-area">
            <img src="https://amarilyskg.co.id/bootstrap/img/logo.png" alt="Logo AKG" class="logo">
            <div class="company-name">PT. AMARILYS KARISMA GEMILANG</div>
        </div>
        <div class="title">KARTU RIWAYAT</div>
    </div>

    <div class="meta-section">
        <div class="machine-info">
            <div><span class="label">NAMA MESIN</span> : <span id="v_nama">-</span></div>
            <div><span class="label">NO. MESIN</span> : <span id="v_no">-</span></div>
            <div><span class="label">TAHUN PEMBUATAN</span> : <span id="v_thn">-</span></div>
            <div><span class="label">LOKASI MESIN</span> : <span id="v_lok">-</span></div>
        </div>
        <div class="doc-info">
            <div><b>No Dokumen</b><span style="margin-left: 28px;">: AF.SP 05.18.Rev-00</span></div>
            <div><b>Tanggal Terbit</b><span style="margin-left: 20px;">: 02 Agustus 2024</span></div>
            <div><b>Halaman</b><span style="margin-left: 45px;">: 1/1</span></div>
            <div><b>Tanggal Revisi</b><span style="margin-left: 17px;">: -</span></div>
        </div>
    </div>

    <table class="main-table">
        <thead>
            <tr>
                <th style="width: 12%">Tanggal</th>
                <th style="width: 22%">Permasalahan</th>
                <th style="width: 22%">Tindakan</th>
                <th style="width: 22%">Spare Part</th>
                <th style="width: 12%">Keterangan</th>
                <th style="width: 10%">PIC</th>
            </tr>
        </thead>
        <tbody id="contentTable">
            <tr><td colspan="6" style="height: 300px; color: #ccc;">Silahkan Cari Nama Mesin...</td></tr>
        </tbody>
    </table>

    <table class="sig-table">
        <tr>
            <td class="sig-header">DIBUAT</td>
            <td class="sig-header">DIKETAHUI</td>
            <td class="sig-header">DISETUJUI</td>
        </tr>
        <tr>
            <td class="sig-space"><img id="s_eng"></td>
            <td class="sig-space"><img id="s_spt"></td>
            <td class="sig-space"><img id="s_mn"></td>
        </tr>
        <tr>
            <td class="sig-footer" id="n_eng">PIC</td>
            <td class="sig-footer">SPV / SUPERINTENDENT</td>
            <td class="sig-footer">MANAGER</td>
        </tr>
    </table>
</div>

<script>
    const SB_URL = "https://yutxomhfqodjzqqibewd.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1dHhvbWhmcW9kanpxcWliZXdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzNjMxODcsImV4cCI6MjA4MTkzOTE4N30.FWmgcuo517KhN0ujLNEZnYZlZ-vbo-jXz3HJjiEJ1tA";
    const _sb = supabase.createClient(SB_URL, SB_KEY);

    async function searchData() {
        const query = document.getElementById('input_search').value.toUpperCase();
        if(!query) return alert("Ketik nama mesin!");

        // Penarikan data otomatis
        const { data: res, error } = await _sb.from('laporan_maintenance').select(`
            *, maintenance_problems(description), maintenance_actions(description), maintenance_parts(*)
        `).eq('nama_mesin', query).order('jam_mulai', { ascending: true });

        if(res && res.length > 0) {
            document.getElementById('v_nama').innerText = res[0].nama_mesin;
            const tbody = document.getElementById('contentTable');
            tbody.innerHTML = res.map(row => `
                <tr>
                    <td>${row.jam_mulai ? row.jam_mulai.split('T')[0] : '-'}</td>
                    <td style="text-align:left">${row.maintenance_problems.map(p => p.description).join(', ')}</td>
                    <td style="text-align:left">${row.maintenance_actions.map(a => a.description).join(', ')}</td>
                    <td style="text-align:left">${row.maintenance_parts.map(pt => pt.nama_part).join(', ')}</td>
                    <td>-</td>
                    <td>${row.engineer_name}</td>
                </tr>
            `).join('');
            
            // Mengisi baris kosong agar tabel tetap penuh
            for(let i = res.length; i < 12; i++) {
                tbody.innerHTML += `<tr><td style="height:25px"></td><td></td><td></td><td></td><td></td><td></td></tr>`;
            }

            // Menampilkan tanda tangan terakhir
            const last = res[res.length - 1];
            document.getElementById('s_eng').src = last.signature_engineer || '';
            document.getElementById('n_eng').innerText = last.engineer_name || 'PIC';
            document.getElementById('s_spt').src = last.signature_superintendent || '';
            document.getElementById('s_mn').src = last.signature_manager || '';
        } else {
            alert("Data tidak ditemukan.");
        }
    }
</script>
</body>
</html>
