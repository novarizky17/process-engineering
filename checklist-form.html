<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Form Checklist Tooling Injection</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; color: #333; }
    header { background-color: #003366; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
    .logo { font-size: 1.5em; font-weight: bold; }
    .back-btn { background-color: #004085; color: white; padding: 8px 15px; border-radius: 6px; text-decoration: none; font-weight: bold; }
    .main-content { padding: 20px; max-width: 900px; margin: 0 auto; }
    h1 { text-align: center; margin-bottom: 20px; }
    .info { text-align: center; font-size: 1.1em; margin-bottom: 30px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); line-height: 1.6; }
    .form-container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    .section { margin-bottom: 40px; border: 1px solid #eee; padding: 20px; border-radius: 10px; }
    .section h3 { font-size: 1.5em; border-bottom: 2px solid #003366; padding-bottom: 10px; margin-top: 0; color: #003366; }
    .section h4 { color: #155724; font-size: 1.2em; margin: 20px 0 10px 0; background: #e9f7ef; padding: 5px 10px; border-radius: 4px; }
    .item { border-bottom: 1px solid #eee; padding: 15px 0; }
    .item-row { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .item-label { font-size: 1.1em; font-weight: bold; flex: 1; min-width: 200px; }
    .status-group { display: flex; gap: 30px; }
    .status-group label { display: flex; align-items: center; gap: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer; }
    input[type="radio"] { transform: scale(1.4); cursor: pointer; }
    .keterangan { display: none; margin-top: 10px; width: 100%; }
    .keterangan textarea { width: 100%; height: 70px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; resize: vertical; box-sizing: border-box; }
    .signature-area { margin-top: 30px; padding: 20px; border: 2px dashed #003366; border-radius: 10px; text-align: center; background: #fafafa; }
    .sig-pad { background: white; border: 1px solid #ccc; border-radius: 8px; cursor: crosshair; touch-action: none; width: 100%; max-width: 400px; height: 180px; display: block; margin: 10px auto; }
    .btn-clear { background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-top: 10px; }
    .btn-submit { background-color: #28a745; color: white; padding: 18px 40px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.3em; width: 100%; font-weight: bold; margin-top: 30px; display: block; transition: background 0.3s; }
    .btn-submit:hover { background-color: #218838; }
    .btn-submit:disabled { background-color: #ccc; cursor: not-allowed; }
  </style>
</head>
<body>

  <header>
    <div class="logo">TOOLING SUPPORT</div>
    <a href="index.html" class="back-btn">Kembali</a>
  </header>

  <div class="main-content">
    <h1>Checklist Pelaksana</h1>
    <div class="info">
      MINGGU: <strong id="weekChecklist">-</strong> | 
      Pelaksana: <strong id="pelaksanaNama">-</strong> | 
      Mesin: <strong id="merkMesin">-</strong> | 
      Tanggal: <strong id="tanggalChecklist">-</strong>
    </div>

    <div class="form-container">
      <div id="form-body">
        <div class="section">
          <h3>1. STAND LABEL</h3>
          <h4>ELECTRICAL</h4>
          <div id="items-stand-elec"></div>
          <h4>MOTION</h4>
          <div id="items-stand-motion"></div>
          <h4>PNEUMATIC</h4>
          <div id="items-stand-pneu"></div>
          <h4>TAKE OUT PRODUK</h4>
          <div id="items-stand-takeout"></div>
        </div>

        <div class="section">
          <h3>2. STACKING</h3>
          <h4>ELECTRICAL</h4>
          <div id="items-stack-elec"></div>
          <h4>MOTION</h4>
          <div id="items-stack-motion"></div>
          <h4>PNEUMATIC</h4>
          <div id="items-stack-pneu"></div>
        </div>

        <div class="section">
          <h3>3. CONVEYOR</h3>
          <div id="items-conveyor"></div>
        </div>

        <div class="section">
          <h3>4. DOSING</h3>
          <div id="items-dosing"></div>
        </div>

        <div class="section">
          <h3>5. DUMMY</h3>
          <div id="items-dummy"></div>
        </div>
      </div>

      <div class="signature-area">
        <strong>Tanda Tangan Pelaksana:</strong>
        <canvas id="canvas-pelaksana" class="sig-pad"></canvas>
        <button class="btn-clear" onclick="clearSignature()">Bersihkan</button>
      </div>

      <button class="btn-submit" id="btnSimpan" onclick="simpanChecklist()">SIMPAN DATA CHECKLIST</button>
    </div>
  </div>

  <script>
    const supabaseUrl = 'https://yutxomhfqodjzqqibewd.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1dHhvbWhmcW9kanpxcWliZXdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzNjMxODcsImV4cCI6MjA4MTkzOTE4N30.FWmgcuo517KhN0ujLNEZnYZlZ-vbo-jXz3HJjiEJ1tA';
    const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const config = [
      { container: 'items-stand-elec', fields: ['wiring', 'komponen', 'kerapihan', 'sensor'] },
      { container: 'items-stand-motion', fields: ['timing_belt', 'pully', 'servo_motor', 'linear_bearing', 'rotary_actuator'] },
      { container: 'items-stand-pneu', fields: ['selenoid_valve', 'vacuum_ejector', 'silinder_pneumatic', 'napple', 'vacuum_pad'] },
      { container: 'items-stand-takeout', fields: ['flange', 'vacuum_pad_takeout'] },
      { container: 'items-stack-elec', fields: ['stacking_wiring', 'stacking_sensor'] },
      { container: 'items-stack-motion', fields: ['stacking_linier', 'stacking_mechanical_part'] },
      { container: 'items-stack-pneu', fields: ['stacking_cylinder', 'stacking_pneumatic'] },
      { container: 'items-conveyor', fields: ['conveyor_belt', 'conveyor_motor', 'conveyor_rantai', 'conveyor_frame', 'conveyor_inverter'] },
      { container: 'items-dosing', fields: ['dosing_alarm', 'dosing_setting'] },
      { container: 'items-dummy', fields: ['dummy_vacuum', 'dummy_condition', 'dummy_flange', 'dummy_instalasi', 'dummy_tubbing'] }
    ];

    function generateItems() {
      config.forEach(group => {
        const div = document.getElementById(group.container);
        group.fields.forEach(f => {
          const label = f.replace(/stacking_|conveyor_|dosing_|dummy_|_/g, ' ').toUpperCase();
          div.innerHTML += `
            <div class="item">
              <div class="item-row">
                <span class="item-label">${label}</span>
                <div class="status-group">
                  <label><input type="radio" name="${f}" value="OK" onclick="toggleKet('${f}', false)"> OK</label>
                  <label><input type="radio" name="${f}" value="NG" onclick="toggleKet('${f}', true)"> NG</label>
                </div>
              </div>
              <div id="box-${f}" class="keterangan">
                <textarea id="text-${f}" placeholder="Alasan NG untuk ${label}..."></textarea>
              </div>
            </div>`;
        });
      });
    }

    function toggleKet(name, show) {
      document.getElementById(`box-${name}`).style.display = show ? 'block' : 'none';
    }

    const canvas = document.getElementById('canvas-pelaksana');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let points = 0;

    canvas.width = 400; canvas.height = 180;
    ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.strokeStyle = '#000';

    function getPos(e) {
      const r = canvas.getBoundingClientRect();
      const clientX = e.clientX || (e.touches && e.touches[0].clientX);
      const clientY = e.clientY || (e.touches && e.touches[0].clientY);
      return { x: clientX - r.left, y: clientY - r.top };
    }

    canvas.onmousedown = (e) => { isDrawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); };
    canvas.onmousemove = (e) => { if(!isDrawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); points++; };
    window.onmouseup = () => isDrawing = false;
    canvas.ontouchstart = (e) => { e.preventDefault(); isDrawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); };
    canvas.ontouchmove = (e) => { e.preventDefault(); if(!isDrawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); points++; };
    function clearSignature() { ctx.clearRect(0,0,canvas.width,canvas.height); points = 0; }

    async function init() {
      generateItems();
      const pId = localStorage.getItem('pelaksana_id');
      if (!pId) return window.location.assign('index.html');
      
      const { data } = await _supabase.from('pelaksana').select('*').eq('id', pId).single();
      if (data) {
        document.getElementById('weekChecklist').textContent = data.week || '-';
        document.getElementById('pelaksanaNama').textContent = data.nama_pelaksana;
        document.getElementById('merkMesin').textContent = data.merk_mesin;
        document.getElementById('tanggalChecklist').textContent = data.tanggal_checklist;
      }
    }

    async function simpanChecklist() {
      const pId = localStorage.getItem('pelaksana_id');
      if (points < 10) return alert("Tanda tangan wajib diisi!");

      let payload = { 
        pelaksana_id: pId, 
        status: 'Pending', 
        signature_pelaksana: canvas.toDataURL() 
      };
      
      const allFields = config.flatMap(g => g.fields);
      
      for (const f of allFields) {
        const radio = document.querySelector(`input[name="${f}"]:checked`);
        if (!radio) return alert("Mohon lengkapi semua item!");
        
        payload[f] = radio.value;
        const ketInput = document.getElementById(`text-${f}`);
        const ketValue = ketInput ? ketInput.value.trim() : "";
        
        if (radio.value === 'NG') {
          if (!ketValue) return alert("Item " + f.replace(/_/g, ' ').toUpperCase() + " NG wajib diisi keterangan!");
          
          // MENGGUNAKAN KOLOM _keterangan SESUAI DATABASE ANDA
          payload[`${f}_keterangan`] = ketValue;
        }
      }

      document.getElementById('btnSimpan').disabled = true;
      document.getElementById('btnSimpan').textContent = "Mengirim...";

      const { error } = await _supabase.from('checklist').insert([payload]);
      
      if (error) {
        alert("Gagal: " + error.message);
        document.getElementById('btnSimpan').disabled = false;
        document.getElementById('btnSimpan').textContent = "SIMPAN DATA CHECKLIST";
      } else {
        alert("Berhasil!");
        localStorage.removeItem('pelaksana_id');
        window.location.assign('index.html');
      }
    }

    window.onload = init;
  </script>
</body>
</html>
