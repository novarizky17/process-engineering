<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Laporan Perawatan & Overhaul</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f1f5f9; padding: 20px; font-family: sans-serif; }
        .form-card { max-width: 900px; background: white; margin: 0 auto; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); border: 1px solid #e2e8f0; }
        .section-title { font-weight: bold; font-size: 11pt; color: #1e293b; margin-bottom: 12px; border-bottom: 2px solid #3b82f6; display: inline-block; padding-bottom: 2px; }
        .input-field { width: 100%; border: 1px solid #cbd5e1; padding: 8px 12px; border-radius: 6px; outline: none; transition: border 0.2s; }
        .input-field:focus { border-color: #3b82f6; }
        .dotted-input { width: 100%; border: none; border-bottom: 1px dotted #94a3b8; outline: none; padding: 4px 0; }
        .sig-canvas { border: 2px dashed #cbd5e1; background: #f8fafc; border-radius: 8px; width: 100%; height: 150px; cursor: crosshair; touch-action: none; }
        .btn-submit { background-color: #1e3a8a; color: white; padding: 12px 40px; border-radius: 8px; font-weight: bold; transition: all 0.2s; width: 100%; }
        .btn-submit:hover { background-color: #1e40af; transform: translateY(-1px); }
        .btn-submit:disabled { background-color: #94a3b8; cursor: not-allowed; }
    </style>
</head>
<body>

    <div class="form-card">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-slate-800">Form Pengisian Laporan Overhaul</h1>
            <button onclick="window.location.href='laporan.html'" class="text-sm text-slate-500 underline">Kembali ke Dashboard</button>
        </div>

        <form id="formOverhaul">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <label class="block text-sm font-semibold mb-1">Nama Mesin, Tools/Equipment:</label>
                    <input type="text" id="nama_mesin" class="input-field" placeholder="Contoh: IRON MAN / COMPRESSOR">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">Tipe Pekerjaan:</label>
                    <div class="flex gap-6 mt-2">
                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="job_type" value="Perawatan" class="w-4 h-4"> Perawatan</label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="job_type" value="Overhaul" class="w-4 h-4"> Overhaul</label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">Tanggal & Jam Mulai:</label>
                    <input type="datetime-local" id="jam_mulai" class="input-field">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">Tanggal & Jam Selesai:</label>
                    <input type="datetime-local" id="jam_selesai" class="input-field">
                </div>
            </div>

            <div class="mb-8">
                <span class="section-title text-blue-700">1. Deskripsi Masalah</span>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 mt-2">
                    <script>
                        for(let i=1; i<=4; i++) {
                            ['a','b'].forEach(col => {
                                document.write(`
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" name="prob_check_${col}_${i}" class="w-4 h-4">
                                        <input type="text" name="prob_text_${col}_${i}" class="dotted-input" placeholder="Baris ${i}${col}...">
                                    </div>
                                `);
                            });
                        }
                    </script>
                </div>
            </div>

            <div class="mb-8">
                <span class="section-title text-green-700">2. Pekerjaan & Tindakan Diambil</span>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 mt-2">
                    <script>
                        for(let i=1; i<=4; i++) {
                            ['a','b'].forEach(col => {
                                document.write(`
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" name="act_check_${col}_${i}" class="w-4 h-4">
                                        <input type="text" name="act_text_${col}_${i}" class="dotted-input" placeholder="Baris ${i}${col}...">
                                    </div>
                                `);
                            });
                        }
                    </script>
                </div>
            </div>

            <div class="mb-8">
                <span class="section-title text-orange-700">3. Penggantian Part (Jika Ada)</span>
                <div class="overflow-x-auto mt-2">
                    <table class="w-full text-sm border-collapse border border-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="border p-2">Nama Part</th>
                                <th class="border p-2 w-20">QTY</th>
                                <th class="border p-2 w-40">Tindak Lanjut</th>
                            </tr>
                        </thead>
                        <tbody>
                            <script>
                                for(let i=1; i<=5; i++) {
                                    document.write(`
                                        <tr>
                                            <td class="border p-1"><input type="text" name="part_n_${i}" class="w-full outline-none px-2"></td>
                                            <td class="border p-1"><input type="number" name="part_q_${i}" class="w-full text-center outline-none"></td>
                                            <td class="border p-1 text-center">
                                                <select name="part_act_${i}" class="text-xs">
                                                    <option value="">- Pilih -</option>
                                                    <option value="Ganti">Ganti Baru</option>
                                                    <option value="Repair">Repair</option>
                                                </select>
                                            </td>
                                        </tr>
                                    `);
                                }
                            </script>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="mb-8">
                <span class="section-title text-slate-700">4. Rekomendasi & Catatan Tambahan</span>
                <textarea id="catatan" rows="3" class="input-field mt-2" placeholder="Saran pengerjaan selanjutnya..."></textarea>
            </div>

            <div class="mb-10 max-w-md mx-auto text-center">
                <label class="block font-bold mb-2">Tanda Tangan Engineer (Pelaksana):</label>
                <div class="relative">
                    <canvas id="can-eng" class="sig-canvas"></canvas>
                    <button type="button" onclick="resetCan()" class="absolute top-2 right-2 text-xs text-red-500 underline">Hapus TTD</button>
                </div>
                <input type="text" id="name_engineer" class="input-field mt-4 text-center font-bold" placeholder="NAMA TERANG ENGINEER">
            </div>

            <button type="button" id="btnSave" onclick="saveData()" class="btn-submit">SIMPAN LAPORAN SEKARANG</button>
        </form>
    </div>

    <div id="modalOk" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[100]">
        <div class="bg-white p-8 rounded-xl shadow-2xl text-center max-w-sm w-full mx-4">
            <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg>
            </div>
            <h2 class="text-xl font-bold text-slate-800 mb-2">Berhasil Disimpan!</h2>
            <p class="text-slate-500 mb-6 text-sm">Laporan telah masuk ke sistem riwayat maintenance.</p>
            <button onclick="window.location.reload()" class="bg-blue-900 text-white px-8 py-2 rounded-lg font-bold w-full">OK</button>
        </div>
    </div>

    <script>
        const SB_URL = "https://yutxomhfqodjzqqibewd.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1dHhvbWhmcW9kanpxcWliZXdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzNjMxODcsImV4cCI6MjA4MTkzOTE4N30.FWmgcuo517KhN0ujLNEZnYZlZ-vbo-jXz3HJjiEJ1tA";
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        const canvas = document.getElementById('can-eng');
        const ctx = canvas.getContext('2d');
        let painting = false;

        function init() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
        window.onload = init;

        function start(e) { painting = true; draw(e); }
        function end() { painting = false; ctx.beginPath(); }
        function draw(e) {
            if (!painting) return;
            ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = "#000";
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
            const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
            ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
        }

        canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', draw); window.addEventListener('mouseup', end);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); start(e); }); canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); }); canvas.addEventListener('touchend', end);
        function resetCan() { ctx.clearRect(0,0,canvas.width,canvas.height); }

        async function saveData() {
            const mesin = document.getElementById('nama_mesin').value;
            const eng = document.getElementById('name_engineer').value;
            const jobType = document.querySelector('input[name="job_type"]:checked')?.value;
            const tglMulaiVal = document.getElementById('jam_mulai').value;
            const tglSelesaiVal = document.getElementById('jam_selesai').value;
            const btn = document.getElementById('btnSave');

            if (!mesin || !eng || !jobType || !tglMulaiVal) return alert("Lengkapi data Mesin, Tipe Job, Tanggal Mulai, dan Nama!");

            btn.disabled = true; btn.innerText = "SEDANG MENYIMPAN...";

            try {
                // Konversi pilihan tanggal manual ke format ISO agar tidak tertimpa waktu sekarang di database
                const isoMulai = new Date(tglMulaiVal).toISOString();
                const isoSelesai = tglSelesaiVal ? new Date(tglSelesaiVal).toISOString() : null;

                const { data: mainData, error: mainError } = await _sb.from('laporan_maintenance').insert([{
                    nama_mesin: mesin.toUpperCase(), 
                    job_type: jobType,
                    jam_mulai: isoMulai, 
                    jam_selesai: isoSelesai,
                    engineer_name: eng.toUpperCase(), 
                    signature_engineer: canvas.toDataURL(),
                    rekomendasi_catatan: document.getElementById('catatan').value,
                    status: 'Maintenance_Done'
                }]).select().single();

                if (mainError) throw mainError;
                const mId = mainData.id;

                // Problems
                const problems = [];
                for(let i=1; i<=4; i++) {
                    ['a','b'].forEach(col => {
                        const txt = document.getElementsByName(`prob_text_${col}_${i}`)[0].value;
                        const chk = document.getElementsByName(`prob_check_${col}_${i}`)[0].checked;
                        if(txt) problems.push({ maintenance_id: mId, description: txt, is_checked: chk });
                    });
                }
                if(problems.length > 0) await _sb.from('maintenance_problems').insert(problems);

                // Actions
                const actions = [];
                for(let i=1; i<=4; i++) {
                    ['a','b'].forEach(col => {
                        const txt = document.getElementsByName(`act_text_${col}_${i}`)[0].value;
                        const chk = document.getElementsByName(`act_check_${col}_${i}`)[0].checked;
                        if(txt) actions.push({ maintenance_id: mId, description: txt, is_checked: chk });
                    });
                }
                if(actions.length > 0) await _sb.from('maintenance_actions').insert(actions);

                // Parts
                const parts = [];
                for(let i=1; i<=5; i++) {
                    const name = document.getElementsByName(`part_n_${i}`)[0].value;
                    const qty = document.getElementsByName(`part_q_${i}`)[0].value;
                    const act = document.getElementsByName(`part_act_${i}`)[0].value;
                    if(name) parts.push({ maintenance_id: mId, nama_part: name, qty: parseInt(qty) || 0, tindak_lanjut: act });
                }
                if(parts.length > 0) await _sb.from('maintenance_parts').insert(parts);

                document.getElementById('modalOk').classList.remove('hidden');
            } catch (err) { 
                console.error(err); 
                alert("Error simpan: " + err.message); 
                btn.disabled = false; 
                btn.innerText = "SIMPAN LAPORAN SEKARANG"; 
            }
        }
    </script>
</body>
</html>
